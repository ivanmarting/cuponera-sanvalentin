<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snoopy Skate üõπ - Smooth World Edition</title>
    <link rel="stylesheet" href="../assets/scss/main.css">
</head>
<body class="jump-page">
    <nav class="navbar">
        <div class="dropdown">
            <button onclick="toggleMenu(event)" class="dropbtn">‚ò∞</button>
            <div id="myDropdown" class="dropdown-content">
                <a href="../index.html">üè† Inicio</a>
                <a href="memorygame.html">üß© Memoria</a>
                <a href="quizgame.html">üß† Preguntados</a>
                <a href="cooking_v2.html">üë®‚Äçüç≥ Food Truck</a>
                <a href="#" onclick="adminMenu()">‚öôÔ∏è Admin</a>
            </div>
        </div>
    </nav>

    <button id="mute-btn" onclick="toggleMusic()">üîä</button>
    <button id="fullscreen-btn" onclick="toggleFullScreen()">Pantalla Completa üì±</button>

    <div id="game-ui">
        <div class="score">Pts: <span id="current-score">0</span></div>
        <div style="font-weight: bold; color: #eee; font-size: 0.9rem;">R√©cord: <span id="high-score">0</span> | Meta: <span id="target-ui">1000</span></div>
    </div>

    <div class="mobile-controls" id="touch-controls">
        <div class="control-group"> 
            <div class="control-btn" id="btn-up">‚Üë</div>
            <div class="control-btn" id="btn-down">‚Üì</div>
        </div>
        <div class="control-group"> 
            <div class="control-btn" id="btn-jump">SALTAR</div>
            <div class="control-btn" id="btn-duck">AGACHA</div>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>
    <div id="start-screen" class="modal" style="display: block;">
        <h2>Snoopy Skate üõπ</h2>
        <p>¬°Us√° el celu en <b>Horizontal</b>!<br><br>
        üëÜüëá Desliza pantalla o usa flechas para cambiar carril.<br>
        üîò Botones derecha para saltar o agacharte.</p>
        <button class="btn" onclick="startGame()">¬°A RODAR!</button>
    </div>

    <div id="win-screen" class="modal" style="display: none;">
        <h2>¬°BIEN AH√ç! üèÜ</h2>
        <div id="codigo-premio" style="font-size: 1.8rem; font-weight: bold; color: #fb6f92; margin: 15px 0; background: #fff0f5; padding: 10px; border-radius: 15px;">---</div>
        <button class="btn" onclick="closeWin()">SEGUIR JUGANDO</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <audio id="bg-music" loop src="../assets/songs/jump_music.mp3"></audio>
    <audio id="sfx-jump" src="../assets/songs/jump_sfx.mp3"></audio>
    <audio id="sfx-crash" src="../assets/songs/crash_sfx.mp3"></audio>

    <script src="../assets/js/main.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Assets
        const snoopySkate = new Image(); snoopySkate.src = '../assets/images/snoopy_skate.png';
        const snoopyJump = new Image(); snoopyJump.src = '../assets/images/snoopy_jump.png';
        const snoopyDuck = new Image(); snoopyDuck.src = '../assets/images/snoopy_duck.png';
        const carImg = new Image(); carImg.src = '../assets/images/autito.png';
        const birdImg = new Image(); birdImg.src = '../assets/images/pajarito.png';
        const truckImg = new Image(); truckImg.src = '../assets/images/camion.png';

        const music = document.getElementById('bg-music');
        const sfxJump = document.getElementById('sfx-jump');
        const sfxCrash = document.getElementById('sfx-crash');

        const CODIGOS_MAESTROS = ["culogordo", "ternerito", "bebota", "elefante", "woodstuck", "papasfritas", "hombreara√±a", "silenciogil", "chipamboca", "gatitoexplota", "pinguinoenojado", "esnupi", "ca1000", "hayquematarlo"];
        
        // Variables globales
        let gameRunning = false, score = 0, obstacles = [], frame = 0, gameSpeed = 7, roadOffset = 0;
        let bgProps = []; 
        let currentTheme = 'city'; 
        let timeState = 'day';
        
        // --- SISTEMA DE COLORES Y TRANSICIONES ---
        const SKY_COLORS = {
            day: [135, 206, 235],     // Celeste
            evening: [255, 140, 0],   // Naranja atardecer
            night: [11, 16, 38]       // Azul oscuro noche
        };
        const GROUND_COLORS = {
            city: [128, 128, 128],    // Cemento
            desert: [237, 201, 175],  // Arena
            forest: [101, 67, 33],    // Tierra oscura
            mountains: [80, 80, 80]   // Roca
        };

        let currentSkyRGB = [...SKY_COLORS.day];
        let targetSkyRGB = [...SKY_COLORS.day];
        let currentGroundRGB = [...GROUND_COLORS.city];
        let targetGroundRGB = [...GROUND_COLORS.city];

        // Funci√≥n para interpolar (mezclar) colores suavemente
        function lerpColor(current, target, speed) {
            for (let i = 0; i < 3; i++) {
                current[i] += (target[i] - current[i]) * speed;
            }
        }

        let highScore = parseInt(localStorage.getItem('jumpHighScore')) || 0;
        let jumpCodesCount = parseInt(localStorage.getItem('jumpCodesWonCount')) || 0;
        let currentGoal = 1000 + (jumpCodesCount * 500);

        let laneY = []; 
        const player = { lane: 1, x: 120, y: 0, visualY: 0, w: 90, h: 80, dy: 0, jumpForce: 10, gravity: 0.35, grounded: false, ducking: false, baseH: 80, duckH: 40 };

        function updateGoal() {
            currentGoal = 1000 + (jumpCodesCount * 500);
            if(document.getElementById('target-ui')) document.getElementById('target-ui').innerText = currentGoal;
            if(document.getElementById('start-target')) document.getElementById('start-target').innerText = currentGoal;
            if(document.getElementById('high-score')) document.getElementById('high-score').innerText = highScore;
        }

        function resize() { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
            const centerY = canvas.height - 110;
            laneY = [centerY - 45, centerY + 45]; 
            player.visualY = laneY[player.lane];
        }
        window.addEventListener('resize', resize); resize(); updateGoal();

        // --- CONTROLES ---
        let touchStartY = 0;
        window.addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; });
        window.addEventListener('touchend', e => {
            if(!gameRunning) return;
            const diff = touchStartY - e.changedTouches[0].clientY;
            if (Math.abs(diff) > 40) { if (diff > 0) player.lane = 0; else player.lane = 1; }
        });

        document.getElementById('btn-up').addEventListener('touchstart', e => { e.preventDefault(); player.lane = 0; });
        document.getElementById('btn-down').addEventListener('touchstart', e => { e.preventDefault(); player.lane = 1; });
        document.getElementById('btn-jump').addEventListener('touchstart', e => { e.preventDefault(); jump(); });
        document.getElementById('btn-duck').addEventListener('touchstart', e => { e.preventDefault(); duck(true); });
        document.getElementById('btn-duck').addEventListener('touchend', e => { e.preventDefault(); duck(false); });

        window.addEventListener('keydown', e => { 
            if(e.code === 'KeyW' || e.code === 'ArrowUp') player.lane = 0;
            if(e.code === 'KeyS' || e.code === 'ArrowDown') player.lane = 1;
            if(e.code === 'Space') jump();
            if(e.code.includes('Shift')) duck(true);
        });
        window.addEventListener('keyup', e => { if(e.code.includes('Shift')) duck(false); });

        function jump() { 
            if(player.grounded && gameRunning && !player.ducking) { 
                player.dy = -player.jumpForce; player.grounded = false; 
                if(sfxJump) { sfxJump.currentTime = 0; sfxJump.play().catch(()=>{}); }
            } 
        }
        function duck(is) { if(!gameRunning) return; player.ducking = is; player.h = is ? player.duckH : player.baseH; }

        function adminMenu() {
            const pass = prompt("Contrase√±a Admin:");
            if (pass === "ivancito") {
                const act = prompt("1: Reset Puntaje\n2: Cambiar Tema (city, desert, forest, mountains)\n3: Cambiar Hora (day, evening, night)");
                if (act === "1") { localStorage.removeItem('jumpHighScore'); localStorage.removeItem('jumpCodesWonCount'); location.reload(); }
                if (act === "2") { currentTheme = prompt("Tema:").toLowerCase(); bgProps = []; }
                if (act === "3") { timeState = prompt("Hora:").toLowerCase(); }
            }
        }

        function startGame() { 
            updateGoal(); 
            document.getElementById('start-screen').style.display = 'none'; 
            document.getElementById('overlay').style.display = 'none'; 
            document.getElementById('touch-controls').style.display = 'flex';
            gameRunning = true; score = 0; obstacles = []; frame = 0; gameSpeed = 7; bgProps = [];
            // Reset colores al inicio
            currentSkyRGB = [...SKY_COLORS.day]; targetSkyRGB = [...SKY_COLORS.day];
            currentGroundRGB = [...GROUND_COLORS.city]; targetGroundRGB = [...GROUND_COLORS.city];
            if(music) music.play().catch(()=>{}); 
            loop(); 
        }

        // --- L√ìGICA DE ESCENARIOS Y COLORES ---
        function updateEnvironmentState() {
            // Ciclos m√°s largos para transiciones suaves
            const cycle = frame % 12000; 
            if (cycle < 5000) timeState = 'day';
            else if (cycle < 8000) timeState = 'evening';
            else timeState = 'night';

            if (frame % 3000 === 0) {
                const themes = ['city', 'desert', 'forest', 'mountains'];
                currentTheme = themes[Math.floor(Math.random() * themes.length)];
            }

            // Establecer colores objetivo (Targets)
            targetSkyRGB = SKY_COLORS[timeState];
            targetGroundRGB = GROUND_COLORS[currentTheme];
        }

        function updateColors() {
            // Velocidad de transici√≥n (cuanto menor, m√°s suave)
            lerpColor(currentSkyRGB, targetSkyRGB, 0.005);
            lerpColor(currentGroundRGB, targetGroundRGB, 0.01);
        }

        function drawSky() {
            // Usar el color interpolado actual
            ctx.fillStyle = `rgb(${currentSkyRGB[0]}, ${currentSkyRGB[1]}, ${currentSkyRGB[2]})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (timeState === 'night' && currentSkyRGB[2] < 50) { // Solo mostrar estrellas si est√° oscuro
                ctx.fillStyle = `rgba(255, 255, 255, ${1 - currentSkyRGB[2]/255})`; // Estrellas se desvanecen al amanecer
                for(let i=0; i<30; i++) {
                    let x = (Math.sin(i*123.45) + 1) / 2 * canvas.width;
                    let y = (Math.cos(i*543.21) + 1) / 2 * (laneY[0]-150);
                    ctx.fillRect(x, y, 2, 2);
                }
            }

            // Sol/Luna con transici√≥n de color y posici√≥n
            const celestialColor = timeState === 'night' ? [238, 238, 238] : (timeState === 'evening' ? [255, 165, 0] : [255, 215, 0]);
            ctx.fillStyle = `rgb(${celestialColor[0]}, ${celestialColor[1]}, ${celestialColor[2]})`;
            
            let sunY = 80;
            if (timeState === 'evening') sunY = 150; // El sol baja al atardecer

            ctx.beginPath();
            ctx.arc(canvas.width - 100, sunY, 40, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawBackgroundProps() {
             // ... (Mismo c√≥digo de props de la versi√≥n anterior, funciona bien) ...
             if (frame % 80 === 0) {
                let prop = { x: canvas.width, type: currentTheme, w: 0, h: 0, color: '' };
                if (currentTheme === 'city') {
                    prop.w = 60 + Math.random() * 60; prop.h = 100 + Math.random() * 200;
                    prop.color = timeState === 'night' ? '#1a1a1a' : '#333';
                } else if (currentTheme === 'desert') {
                    prop.w = 30; prop.h = 40 + Math.random() * 60; prop.color = '#2d5a27';
                } else if (currentTheme === 'forest') {
                    prop.w = 50 + Math.random() * 40; prop.h = 80 + Math.random() * 100;
                } else if (currentTheme === 'mountains') {
                    prop.w = 150 + Math.random() * 100; prop.h = 150 + Math.random() * 150;
                }
                bgProps.push(prop);
            }

            bgProps.forEach((p, i) => {
                p.x -= gameSpeed * 0.3;
                
                if (p.type === 'city') {
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, laneY[0] - p.h - 40, p.w, p.h);
                    if (timeState === 'night' && currentSkyRGB[2] < 60) { // Ventanas solo si est√° oscuro
                        ctx.fillStyle = Math.random() > 0.5 ? '#FFD700' : '#222';
                        for(let r=0; r<p.h/20; r++) { for(let c=0; c<p.w/20; c++) { if (Math.random() > 0.7) ctx.fillRect(p.x + 5 + c*15, (laneY[0] - p.h - 35) + r*20, 8, 8); }}
                    }
                } else if (p.type === 'desert') {
                    ctx.fillStyle = p.color; ctx.fillRect(p.x, laneY[0] - p.h - 40, 15, p.h); ctx.fillRect(p.x - 10, laneY[0] - p.h/2 - 40, 30, 10);
                } else if (p.type === 'forest') {
                    ctx.fillStyle = '#1e392a'; ctx.beginPath(); ctx.moveTo(p.x, laneY[0] - 40); ctx.lineTo(p.x + p.w, laneY[0] - 40); ctx.lineTo(p.x + p.w/2, laneY[0] - p.h - 40); ctx.fill();
                } else if (p.type === 'mountains') {
                    ctx.fillStyle = '#444'; ctx.beginPath(); ctx.moveTo(p.x, laneY[0] - 40); ctx.lineTo(p.x + p.w, laneY[0] - 40); ctx.lineTo(p.x + p.w/2, laneY[0] - p.h - 40); ctx.fill();
                    ctx.fillStyle = '#eee'; ctx.beginPath(); ctx.moveTo(p.x + p.w*0.35, laneY[0] - p.h*0.7 - 40); ctx.lineTo(p.x + p.w*0.65, laneY[0] - p.h*0.7 - 40); ctx.lineTo(p.x + p.w/2, laneY[0] - p.h - 40); ctx.fill();
                }
                if (p.x + p.w < -200) bgProps.splice(i, 1);
            });
        }

        function loop() {
            if(!gameRunning) return;
            ctx.clearRect(0,0, canvas.width, canvas.height); frame++;
            if(frame % 1000 === 0 && gameSpeed < 14) gameSpeed += 0.5;

            updateEnvironmentState();
            updateColors(); // <--- MAGIA DE TRANSICI√ìN AQU√ç
            drawSky();
            drawBackgroundProps();

            // F√≠sicas y Lerp
            player.dy += player.gravity;
            player.y += player.dy;
            player.visualY += (laneY[player.lane] - player.visualY) * 0.15;

            if(player.y + player.h > player.visualY) {
                player.y = player.visualY - player.h;
                player.dy = 0;
                player.grounded = true;
            }

            let sprite = snoopySkate;
            if(!player.grounded) sprite = snoopyJump;
            else if(player.ducking) sprite = snoopyDuck;
            let bob = (player.grounded && !player.ducking) ? Math.sin(frame * 0.2) * 3 : 0;

            // DIBUJO POR CAPAS
            drawRoadAndGround(); // <--- NUEVA FUNCI√ìN PARA EL SUELO

            obstacles.filter(o => o.lane === 0).forEach(o => {
                o.x -= gameSpeed;
                ctx.drawImage(o.type === 'bird' ? birdImg : (o.type === 'truck' ? truckImg : carImg), o.x, o.y, o.w, o.h);
                checkCollision(o);
            });

            if(player.lane === 0) ctx.drawImage(sprite, player.x, player.y + bob, player.w, player.h);

            obstacles.filter(o => o.lane === 1).forEach(o => {
                o.x -= gameSpeed;
                ctx.drawImage(o.type === 'bird' ? birdImg : (o.type === 'truck' ? truckImg : carImg), o.x, o.y, o.w, o.h);
                checkCollision(o);
            });

            if(player.lane === 1) ctx.drawImage(sprite, player.x, player.y + bob, player.w, player.h);

            if(obstacles.length === 0) ctx.drawImage(sprite, player.x, player.y + bob, player.w, player.h);

            obstacles = obstacles.filter(o => o.x > -200);
            if(frame % 85 === 0) spawn();
            requestAnimationFrame(loop);
        }

        function checkCollision(o) {
            if (o.lane === player.lane) {
                let hit = false;
                if (o.type === 'car') hit = player.x < o.x + o.w - 35 && player.x + player.w > o.x + 35 && player.y + player.h > o.y + 10;
                else if (o.type === 'bird') { if (!player.ducking) hit = player.x < o.x + o.w - 25 && player.x + player.w > o.x + 25 && player.y < o.y + o.h + 10; }
                else if (o.type === 'truck') hit = player.x < o.x + o.w - 20 && player.x + player.w > o.x + 20;
                
                if(hit) gameOver();
                
                if(!o.passed && o.x < player.x) {
                    o.passed = true;
                    score += 100;
                    document.getElementById('current-score').innerText = score;
                    if (score > highScore) { highScore = score; localStorage.setItem('jumpHighScore', highScore); document.getElementById('high-score').innerText = highScore; }
                    checkWinCondition();
                }
            }
        }

        function spawn() {
            if(obstacles.length > 0 && obstacles[obstacles.length-1].x > canvas.width - 280) return;
            const lane = Math.floor(Math.random() * 2);
            const rand = Math.random();

            if (rand < 0.5) { 
                obstacles.push({ x: canvas.width + 80, y: laneY[0] - 105, w: 160, h: 110, type: 'truck', lane: 0, passed: false });
                const t2 = Math.random() > 0.5 ? 'car' : 'bird';
                obstacles.push({ x: canvas.width, y: t2==='car'?laneY[1]-55:laneY[1]-100, w: t2==='car'?90:60, h: t2==='car'?60:50, type: t2, lane: 1, passed: false });
            } else {
                const t = Math.random() > 0.7 ? 'truck' : (Math.random() > 0.4 ? 'car' : 'bird');
                let y = (t === 'truck') ? laneY[lane] - 105 : (t === 'car' ? laneY[lane] - 55 : laneY[lane] - 100);
                obstacles.push({ x: canvas.width, y: y, w: t==='truck'?160:t==='car'?90:60, h: t==='truck'?110:t==='car'?60:50, type: t, lane: lane, passed: false });
            }
        }

        // NUEVA FUNCI√ìN PARA DIBUJAR CARRETERA Y SUELO DIN√ÅMICO
        function drawRoadAndGround() {
            // 1. Carretera (Asfalto)
            ctx.fillStyle = timeState === 'night' ? '#222' : '#444'; // Asfalto m√°s oscuro de noche
            const roadTop = laneY[0] - 60;
            const roadBottom = laneY[1] + 40;
            ctx.fillRect(0, roadTop, canvas.width, roadBottom - roadTop);

            // 2. Suelo debajo de la carretera (Relleno din√°mico)
            ctx.fillStyle = `rgb(${currentGroundRGB[0]}, ${currentGroundRGB[1]}, ${currentGroundRGB[2]})`;
            ctx.fillRect(0, roadBottom, canvas.width, canvas.height - roadBottom);

            // 3. L√≠nea divisoria animada
            roadOffset -= gameSpeed; if (roadOffset < -60) roadOffset = 0;
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.setLineDash([30, 30]); ctx.lineDashOffset = -roadOffset;
            ctx.beginPath(); ctx.moveTo(0, (laneY[0] + laneY[1]) / 2 - 10); ctx.lineTo(canvas.width, (laneY[0] + laneY[1]) / 2 - 10); ctx.stroke(); ctx.setLineDash([]);
        }

        function checkWinCondition() {
            const lastWin = localStorage.getItem('jumpWinTime');
            if(score >= currentGoal && (!lastWin || Date.now() - lastWin > 72*60*60*1000)) {
                gameRunning = false;
                let conseguidos = JSON.parse(localStorage.getItem('codigosConseguidos')) || [];
                let disp = CODIGOS_MAESTROS.filter(c => !conseguidos.includes(c));
                let premio = disp.length > 0 ? disp[Math.floor(Math.random()*disp.length)] : "¬°ERES LA MEJOR!";
                if(disp.length > 0) { 
                    conseguidos.push(premio); 
                    localStorage.setItem('codigosConseguidos', JSON.stringify(conseguidos)); 
                    localStorage.setItem('jumpWinTime', Date.now()); 
                    jumpCodesCount++; 
                    localStorage.setItem('jumpCodesWonCount', jumpCodesCount); 
                }
                document.getElementById('codigo-premio').innerText = premio.toUpperCase(); 
                document.getElementById('win-screen').style.display = 'block'; 
                document.getElementById('overlay').style.display = 'block';
            }
        }

        function gameOver() { 
            gameRunning = false; if(music) music.pause(); if(sfxCrash) sfxCrash.play().catch(()=>{}); 
            setTimeout(() => { alert("¬°Chocaste! Puntaje: " + score); location.reload(); }, 100); 
        }
        function closeWin() { document.getElementById('win-screen').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; gameRunning = true; loop(); }
        function toggleMusic() { music.muted = !music.muted; sfxJump.muted = music.muted; sfxCrash.muted = music.muted; document.getElementById('mute-btn').innerText = music.muted ? "üîá" : "üîä"; }
        function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
    </script>
</body>
</html>