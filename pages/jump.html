<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snoopy Jump</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@700&display=swap');
        :root { --rosa: #fb6f92; --claro: #ffc8dd; --asfalto: #4f5b66; }
        
        body { 
            margin: 0; 
            overflow: hidden; 
            background: linear-gradient(to bottom, #1e3c72 0%, #2a5298 40%, #f18c8e 80%, #ffc371 100%); 
            font-family: 'Quicksand', sans-serif; 
            touch-action: none; 
            user-select: none; 
        }
        
        .navbar { position: fixed; top: 0; width: 100%; display: flex; justify-content: flex-end; padding: 15px; box-sizing: border-box; z-index: 1000; }
        .dropbtn { background: white; color: var(--rosa); padding: 8px 15px; border-radius: 20px; border: 2px solid var(--claro); font-weight: bold; cursor: pointer; }
        .dropdown-content { display: none; position: absolute; right: 15px; top: 50px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; border: 2px solid var(--claro); }
        .dropdown-content a { color: #8a5a6a; padding: 10px 20px; text-decoration: none; display: block; font-size: 0.9rem; cursor: pointer; }
        .show { display: block; }

        #mute-btn { position: fixed; top: 15px; left: 15px; background: white; border: 2px solid var(--claro); padding: 8px 12px; border-radius: 20px; font-weight: bold; color: var(--rosa); cursor: pointer; z-index: 1001; font-size: 1.2rem; }

        #game-ui { position: absolute; width: 100%; text-align: center; top: 60px; pointer-events: none; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); z-index: 100; }
        .score { font-size: 1.8rem; color: white; font-weight: bold; }
        
        /* BOTONES OCULTOS POR DEFECTO */
        .mobile-controls { 
            position: fixed; 
            top: 42%; 
            width: 100%; 
            display: none; /* Se activa en startGame() */
            justify-content: space-between; 
            padding: 0 25px; 
            box-sizing: border-box; 
            z-index: 1000; 
            pointer-events: none;
        }
        .control-btn { 
            width: 85px; 
            height: 85px; 
            background: rgba(255, 255, 255, 0.35); 
            border: 4px solid white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
            font-size: 0.75rem; 
            backdrop-filter: blur(4px); 
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent; 
        }
        .control-btn:active { background: rgba(251, 111, 146, 0.6); transform: scale(0.9); }

        #start-screen, #win-screen, #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; }
        #overlay { background: rgba(0,0,0,0.5); display: none; }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 30px; text-align: center; width: 80%; max-width: 350px; border: 5px solid var(--claro); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .btn { background: var(--rosa); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; margin-top: 15px; width: 100%; font-family: inherit; }
        
        canvas { display: block; background: transparent; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="dropdown">
            <button onclick="document.getElementById('myDropdown').classList.toggle('show')" class="dropbtn">‚ò∞ Men√∫</button>
            <div id="myDropdown" class="dropdown-content">
                <a href="../index.html">üè† Inicio</a>
                <a href="memorygame.html">üß© Memoria</a>
                <a href="quizgame.html">üß† Preguntados</a>
                <a href="djsnoopy.html">üéµ Dj Snoopy</a>
                <a href="codigos.html">üèÜ Mis C√≥digos</a>
                <a onclick="resetCooldown()">üîì Reset Bloqueo (Admin)</a>
            </div>
        </div>
    </nav>

    <button id="mute-btn" onclick="toggleMusic()">üîä</button>

    <div id="game-ui">
        <div class="score">Puntos: <span id="current-score">0</span></div>
        <div style="font-weight: bold; color: #eee; font-size: 0.9rem;">R√©cord: <span id="high-score">0</span></div>
        <div style="color: #ffc8dd; font-size: 0.9rem; font-weight: bold; margin-top: 5px;">Meta: <span id="target-ui">3000</span></div>
    </div>

    <div class="mobile-controls" id="touch-controls">
        <div class="control-btn" id="btn-duck">AGACHAR</div>
        <div class="control-btn" id="btn-jump">SALTAR</div>
    </div>

    <div id="overlay"></div>
    <div id="start-screen"><div class="modal">
        <h2 style="color: var(--rosa)">Snoopy Skate üõπ</h2>
        <p>Llega a <b id="start-target">3000</b> puntos para el c√≥digo.<br><br>
        üöó Salta los autos<br>
        üê¶ Ag√°chate con los p√°jaros</p>
        <button class="btn" onclick="startGame()">¬°EMPEZAR!</button>
    </div></div>

    <div id="win-screen" style="display: none;"><div class="modal">
        <h2 style="color: var(--rosa)">¬°BIEN AH√ç! üèÜ</h2>
        <p>Has ganado un c√≥digo secreto:</p>
        <div id="codigo-premio" style="font-size: 1.8rem; font-weight: bold; color: var(--rosa); margin: 15px 0; background: #fff0f5; padding: 10px; border-radius: 15px;">---</div>
        <button class="btn" onclick="closeWin()">SEGUIR JUGANDO</button>
    </div></div>

    <canvas id="gameCanvas"></canvas>

    <audio id="bg-music" loop src="../assets/songs/jump_music.mp3"></audio>
    <audio id="sfx-jump" src="../assets/songs/jump_sfx.mp3"></audio>
    <audio id="sfx-crash" src="../assets/songs/crash_sfx.mp3"></audio>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const snoopyImg = new Image(); snoopyImg.src = '../assets/images/snoopy_patineta.png';
        const carImg = new Image(); carImg.src = '../assets/images/autito.png';
        const birdImg = new Image(); birdImg.src = '../assets/images/pajarito.png';
        
        const music = document.getElementById('bg-music');
        const sfxJump = document.getElementById('sfx-jump');
        const sfxCrash = document.getElementById('sfx-crash');
        const muteBtn = document.getElementById('mute-btn');

        const CODIGOS_MAESTROS = ["culogordo", "ternerito", "05052025", "bebota", "elefante", "cocodrilo", "mariquita", "01022025", "24032025", "woodstuck", "sanvalentin", "papasfritas", "peonias", "hombreara√±a", "patatuilla", "silenciogil", "chipamboca", "colorincolorao", "gatitoexplota", "pinguinoenojado", "uncodigorandom", "uncodigorandom2", "equisde", "esnupi", "ca1000", "hayquematarlo"];
        
        let gameRunning = false, score = 0, obstacles = [], frame = 0, gameSpeed = 7, buildings = [], groundY;
        let highScore = parseInt(localStorage.getItem('jumpHighScore')) || 0;
        let jumpCodesCount = parseInt(localStorage.getItem('jumpCodesWonCount')) || 0;
        let currentGoal = 3000 + (jumpCodesCount * 500);

        const player = { x: 50, y: 0, w: 85, h: 70, dy: 0, jumpForce: 15, gravity: 0.8, grounded: false, ducking: false, baseH: 70, duckH: 35 };

        function updateGoal() {
            currentGoal = 3000 + (jumpCodesCount * 500);
            document.getElementById('target-ui').innerText = currentGoal;
            document.getElementById('start-target').innerText = currentGoal;
        }

        function toggleMusic() {
            const isMuted = music.muted;
            music.muted = !isMuted;
            sfxJump.muted = !isMuted;
            sfxCrash.muted = !isMuted;
            muteBtn.innerText = music.muted ? "üîá" : "üîä";
        }

        document.getElementById('btn-jump').addEventListener('touchstart', (e) => { 
            e.preventDefault(); 
            if(player.grounded && gameRunning) {
                sfxJump.currentTime = 0;
                sfxJump.play();
                jump();
            }
        });
        document.getElementById('btn-duck').addEventListener('touchstart', (e) => { e.preventDefault(); duck(true); });
        document.getElementById('btn-duck').addEventListener('touchend', (e) => { e.preventDefault(); duck(false); });

        window.addEventListener('keydown', e => { 
            if(e.code === 'Space' || e.code === 'ArrowUp') { 
                e.preventDefault(); 
                if(player.grounded && gameRunning) { sfxJump.currentTime = 0; sfxJump.play(); jump(); }
            }
            if(e.code === 'ArrowDown') { e.preventDefault(); duck(true); }
        });
        window.addEventListener('keyup', e => { if(e.code === 'ArrowDown') duck(false); });

        function jump() { if(player.grounded && gameRunning && !player.ducking) { player.dy = -player.jumpForce; player.grounded = false; } }
        function duck(is) { if(!gameRunning) return; player.ducking = is; player.h = is ? player.duckH : player.baseH; if(player.grounded) player.y = groundY - player.h; }

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; groundY = canvas.height - 100; if(!gameRunning) player.y = groundY - player.h; }
        window.addEventListener('resize', resize); resize(); updateGoal();
        document.getElementById('high-score').innerText = highScore;

        function startGame() { 
            updateGoal(); 
            document.getElementById('start-screen').style.display = 'none'; 
            document.getElementById('overlay').style.display = 'none'; 
            // ACTIVAR BOTONES
            document.getElementById('touch-controls').style.display = 'flex';
            gameRunning = true; score = 0; obstacles = []; frame = 0; gameSpeed = 7; 
            music.play(); 
            loop(); 
        }

        function loop() {
            if(!gameRunning) return;
            ctx.clearRect(0,0, canvas.width, canvas.height); frame++;
            if(score > 0 && score % 1000 === 0) gameSpeed += 0.1;
            drawEnvironment();
            player.dy += player.gravity; player.y += player.dy;
            if(player.y + player.h > groundY) { player.y = groundY - player.h; player.dy = 0; player.grounded = true; }
            let bob = (player.grounded && !player.ducking) ? Math.sin(frame * 0.2) * 3 : 0;
            ctx.save(); ctx.translate(player.x + player.w, player.y + bob); ctx.scale(-1, 1); ctx.drawImage(snoopyImg, 0, 0, player.w, player.h); ctx.restore();
            if(frame % 100 === 0) spawn();
            obstacles.forEach((o, i) => {
                o.x -= gameSpeed; ctx.drawImage(o.type === 'car' ? carImg : birdImg, o.x, o.y, o.w, o.h);
                let hit = false;
                if (o.type === 'car') { hit = player.x < o.x + o.w - 15 && player.x + player.w > o.x + 15 && player.y + player.h > o.y + 10; }
                else { if (!player.ducking) { hit = player.x < o.x + o.w - 10 && player.x + player.w > o.x + 10 && player.y < o.y + o.h + 100; } }
                if(hit) gameOver();
                if(o.x + o.w < 0) { 
                    obstacles.splice(i,1); score += 100; document.getElementById('current-score').innerText = score; 
                    if (score > highScore) { highScore = score; localStorage.setItem('jumpHighScore', highScore); document.getElementById('high-score').innerText = highScore; }
                    checkWinCondition(); 
                }
            });
            requestAnimationFrame(loop);
        }

        function spawn() {
            const isBird = Math.random() > 0.6;
            if (isBird) { obstacles.push({ x: canvas.width, y: groundY - 110, w: 55, h: 45, type: 'bird' }); }
            else { obstacles.push({ x: canvas.width, y: groundY - 45, w: 80, h: 50, type: 'car' }); }
        }

        function drawEnvironment() {
            if(frame % 70 === 0) buildings.push({ x: canvas.width, w: 60+Math.random()*60, h: 100+Math.random()*150, color: `hsla(${Math.random()*40 + 200}, 30%, 20%, 0.5)` });
            buildings.forEach((b, i) => { b.x -= gameSpeed * 0.2; ctx.fillStyle = b.color; ctx.fillRect(b.x, groundY - b.h, b.w, b.h); if(b.x + b.w < 0) buildings.splice(i, 1); });
            ctx.fillStyle = '#333'; ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
            ctx.fillStyle = '#ffffff'; for(let i = -frame % 100; i < canvas.width; i += 100) ctx.fillRect(i, groundY + 40, 60, 10);
        }

        function checkWinCondition() {
            const lastWin = localStorage.getItem('jumpWinTime');
            if(score >= currentGoal && (!lastWin || Date.now() - lastWin > 72*60*60*1000)) {
                gameRunning = false;
                let conseguidos = JSON.parse(localStorage.getItem('codigosConseguidos')) || [];
                let disp = CODIGOS_MAESTROS.filter(c => !conseguidos.includes(c));
                let premio = disp.length > 0 ? disp[Math.floor(Math.random()*disp.length)] : "¬°CAMPEONA!";
                if(disp.length > 0) { conseguidos.push(premio); localStorage.setItem('codigosConseguidos', JSON.stringify(conseguidos)); localStorage.setItem('jumpWinTime', Date.now()); jumpCodesCount++; localStorage.setItem('jumpCodesWonCount', jumpCodesCount); updateGoal(); }
                document.getElementById('codigo-premio').innerText = premio.toUpperCase(); document.getElementById('win-screen').style.display = 'block'; document.getElementById('overlay').style.display = 'block';
            }
        }

        function gameOver() { 
            gameRunning = false; 
            music.pause(); 
            sfxCrash.play(); 
            setTimeout(() => { alert("¬°Chocaste! Puntaje: " + score); location.reload(); }, 100);
        }
        function closeWin() { document.getElementById('win-screen').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; gameRunning = true; loop(); }
        function resetCooldown() { if(prompt("Admin:") === "ivancito") { localStorage.removeItem('jumpWinTime'); localStorage.setItem('jumpCodesWonCount', 0); location.reload(); } }
        window.onclick = e => { if (!e.target.matches('.dropbtn')) document.getElementById("myDropdown").classList.remove('show'); }
    </script>
</body>
</html>